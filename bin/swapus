#!/usr/bin/env ruby

class SwapUsage
  def initialize
    @processes = {}
  end

  def get_processes
    Dir['/proc/[0-9]*'].map do |pid_dir|
      pid = File.basename(pid_dir).to_i
      cmd = File.read("#{pid_dir}/cmdline").tr('\0', ' ')
      swap = File.read("#{pid_dir}/status")[/^VmSwap:\s+([0-9]+)\s+kB$/, 1].to_i

      @processes[pid] = { cmd: cmd, swap: swap } if swap.positive?
    end
  end

  def show
    @processes.sort_by { |_, v| v[:swap] }.each do |pid, values|
      puts "#{values[:swap]} kB [#{pid}] #{values[:cmd]}"
    end
  end

  def run
    get_processes
    show
  end
end

SwapUsage.new.run
